var socket = io();

var cellSize = 14;
var borderWidth = 0;

var ctx;

var map;
var sx;
var sy;

var img = {
    0: `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAABhGlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw1AUhY+ppSIVBzuoOGSoThZERRwlikWwUNoKrTqYvPQPmjQkKS6OgmvBwZ/FqoOLs64OroIg+APi6uKk6CIl3pcUWsR44ZGP8+45ee8+QGhUmGZ1TwCabpupuCRmc6ti6BUChgB0ISgzy0ikFzPwra976qO6i/Es/74/q0/NW4x+JBLPMcO0iTeIZzZtg/M+cYSVZJX4nHjcpAMSP3Jd8fiNc9FlgWdGzExqnjhCLBY7WOlgVjI14mniqKrplC9kPVY5b3HWKjXWOie/YTivr6S5TmsEcSwhgSREKKihjApsxOirk2IhRfuSj3/Y9SfJpZCrDEaOBVShQXb94G/we7ZWYWrSSwpLQPDFcT5GgdAu0Kw7zvex4zRPgMAzcKW3/dUGMPtJer2tRY+A/m3g4rqtKXvA5Q4w+GTIpuxKAVpCoQC8n9Ez5YCBW6B3zZtbax+nD0CGZrV8AxwcAmNFyl73uXdP59z+7WnN7wfke3JuzN/jwQAAAAZiS0dEAAAAAAD/1EFU8gAAAAlwSFlzAAAuIwAALiMBeKU/dgAAAAd0SU1FB+cCGQAEOjIk1lkAAAAZdEVYdENvbW1lbnQAQ3JlYXRlZCB3aXRoIEdJTVBXgQ4XAAAAG0lEQVQoz2O8fPnyfwYyABMDmWBU46jGoaIRAPZ6A5Qm1B9vAAAAAElFTkSuQmCC`,
    1: `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TRZGKQ4sUcchQBcGCqIijVLEIFkpboVUHk0u/oElDkuLiKLgWHPxYrDq4OOvq4CoIgh8gri5Oii5S4v+SQosYD4778e7e4+4dIDQqTDW7JgBVs4xUPCZmc6tizysEhDGIIMYkZuqJ9GIGnuPrHj6+3kV5lve5P0e/kjcZ4BOJ55huWMQbxDObls55nzjESpJCfE48btAFiR+5Lrv8xrnosMAzQ0YmNU8cIhaLHSx3MCsZKvE0cURRNcoXsi4rnLc4q5Uaa92TvzCQ11bSXKc5jDiWkEASImTUUEYFFqK0aqSYSNF+zMM/5PiT5JLJVQYjxwKqUCE5fvA/+N2tWZiadJMCMaD7xbY/RoCeXaBZt+3vY9tungD+Z+BKa/urDWD2k/R6W4scAQPbwMV1W5P3gMsdIPykS4bkSH6aQqEAvJ/RN+WA4C3Qt+b21trH6QOQoa6Wb4CDQ2C0SNnrHu/u7ezt3zOt/n4An59yuV4QJP0AAAAGYktHRAD/AP8A/6C9p5MAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfnAhgWITp6wL4ZAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAADlJREFUKM9jYKA3YMQt9f8/kjIMdUyENWEHTORowqKROE14/IhuANF+JNmpdNDISFrgIPzKxDBkAAAlJgwM7tMjlwAAAABJRU5ErkJggg==`,
    2: `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TRZGKQ4sUcchQBcGCqIijVLEIFkpboVUHk0u/oElDkuLiKLgWHPxYrDq4OOvq4CoIgh8gri5Oii5S4v+SQosYD4778e7e4+4dIDQqTDW7JgBVs4xUPCZmc6tizysEhDGIIMYkZuqJ9GIGnuPrHj6+3kV5lve5P0e/kjcZ4BOJ55huWMQbxDObls55nzjESpJCfE48btAFiR+5Lrv8xrnosMAzQ0YmNU8cIhaLHSx3MCsZKvE0cURRNcoXsi4rnLc4q5Uaa92TvzCQ11bSXKc5jDiWkEASImTUUEYFFqK0aqSYSNF+zMM/5PiT5JLJVQYjxwKqUCE5fvA/+N2tWZiadJMCMaD7xbY/RoCeXaBZt+3vY9tungD+Z+BKa/urDWD2k/R6W4scAQPbwMV1W5P3gMsdIPykS4bkSH6aQqEAvJ/RN+WA4C3Qt+b21trH6QOQoa6Wb4CDQ2C0SNnrHu/u7ezt3zOt/n4An59yuV4QJP0AAAAGYktHRAD/AP8A/6C9p5MAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfnAhgWIg3pUEjVAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAAENJREFUKM9jYKA3YEThVTP8x6u6FaGekWhNaJpZCJmMy1AWnIpJ8iM6QLcJqx8JBRKaixhJ1UA4VAn4mezoYGIYMgAAqBoQmKkZ14cAAAAASUVORK5CYII=`,
    3: `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TRZGKQ4sUcchQBcGCqIijVLEIFkpboVUHk0u/oElDkuLiKLgWHPxYrDq4OOvq4CoIgh8gri5Oii5S4v+SQosYD4778e7e4+4dIDQqTDW7JgBVs4xUPCZmc6tizysEhDGIIMYkZuqJ9GIGnuPrHj6+3kV5lve5P0e/kjcZ4BOJ55huWMQbxDObls55nzjESpJCfE48btAFiR+5Lrv8xrnosMAzQ0YmNU8cIhaLHSx3MCsZKvE0cURRNcoXsi4rnLc4q5Uaa92TvzCQ11bSXKc5jDiWkEASImTUUEYFFqK0aqSYSNF+zMM/5PiT5JLJVQYjxwKqUCE5fvA/+N2tWZiadJMCMaD7xbY/RoCeXaBZt+3vY9tungD+Z+BKa/urDWD2k/R6W4scAQPbwMV1W5P3gMsdIPykS4bkSH6aQqEAvJ/RN+WA4C3Qt+b21trH6QOQoa6Wb4CDQ2C0SNnrHu/u7ezt3zOt/n4An59yuV4QJP0AAAAGYktHRAD/AP8A/6C9p5MAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfnAhgWIhpqg80SAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAAD5JREFUKM9jYKA3YIQx/jMw/CdCMVw9Eym2IBvOSIYGRpJtxOpHXDZQxY8EbaSpH1lIiUdkwESivxgZBgwAAIGYDBHedlafAAAAAElFTkSuQmCC`,
    4: `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TRZGKQ4sUcchQBcGCqIijVLEIFkpboVUHk0u/oElDkuLiKLgWHPxYrDq4OOvq4CoIgh8gri5Oii5S4v+SQosYD4778e7e4+4dIDQqTDW7JgBVs4xUPCZmc6tizysEhDGIIMYkZuqJ9GIGnuPrHj6+3kV5lve5P0e/kjcZ4BOJ55huWMQbxDObls55nzjESpJCfE48btAFiR+5Lrv8xrnosMAzQ0YmNU8cIhaLHSx3MCsZKvE0cURRNcoXsi4rnLc4q5Uaa92TvzCQ11bSXKc5jDiWkEASImTUUEYFFqK0aqSYSNF+zMM/5PiT5JLJVQYjxwKqUCE5fvA/+N2tWZiadJMCMaD7xbY/RoCeXaBZt+3vY9tungD+Z+BKa/urDWD2k/R6W4scAQPbwMV1W5P3gMsdIPykS4bkSH6aQqEAvJ/RN+WA4C3Qt+b21trH6QOQoa6Wb4CDQ2C0SNnrHu/u7ezt3zOt/n4An59yuV4QJP0AAAAGYktHRAD/AP8A/6C9p5MAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfnAhgWIiM1hkUaAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAADhJREFUKM9jYKA3YMQUqv6PYLcyYvIhgIlcG5nw20a0RrL8iGwbPgBxCRMVQ5VQKFM3VOmgkf4AAGbWChI/kX+pAAAAAElFTkSuQmCC`,
    5: `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TRZGKQ4sUcchQBcGCqIijVLEIFkpboVUHk0u/oElDkuLiKLgWHPxYrDq4OOvq4CoIgh8gri5Oii5S4v+SQosYD4778e7e4+4dIDQqTDW7JgBVs4xUPCZmc6tizysEhDGIIMYkZuqJ9GIGnuPrHj6+3kV5lve5P0e/kjcZ4BOJ55huWMQbxDObls55nzjESpJCfE48btAFiR+5Lrv8xrnosMAzQ0YmNU8cIhaLHSx3MCsZKvE0cURRNcoXsi4rnLc4q5Uaa92TvzCQ11bSXKc5jDiWkEASImTUUEYFFqK0aqSYSNF+zMM/5PiT5JLJVQYjxwKqUCE5fvA/+N2tWZiadJMCMaD7xbY/RoCeXaBZt+3vY9tungD+Z+BKa/urDWD2k/R6W4scAQPbwMV1W5P3gMsdIPykS4bkSH6aQqEAvJ/RN+WA4C3Qt+b21trH6QOQoa6Wb4CDQ2C0SNnrHu/u7ezt3zOt/n4An59yuV4QJP0AAAAGYktHRAD/AP8A/6C9p5MAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfnAhgWIi88MAkxAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAAD1JREFUKM9jYKA3YIQxqhkY/hOjoRWqh4lcG1nwmYoPMNHFj8guIclGZMMZSdVAvVAlNh7J8mMrkV6jDQAAvisKFlpERkoAAAAASUVORK5CYII=`,
    6: `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TRZGKQ4sUcchQBcGCqIijVLEIFkpboVUHk0u/oElDkuLiKLgWHPxYrDq4OOvq4CoIgh8gri5Oii5S4v+SQosYD4778e7e4+4dIDQqTDW7JgBVs4xUPCZmc6tizysEhDGIIMYkZuqJ9GIGnuPrHj6+3kV5lve5P0e/kjcZ4BOJ55huWMQbxDObls55nzjESpJCfE48btAFiR+5Lrv8xrnosMAzQ0YmNU8cIhaLHSx3MCsZKvE0cURRNcoXsi4rnLc4q5Uaa92TvzCQ11bSXKc5jDiWkEASImTUUEYFFqK0aqSYSNF+zMM/5PiT5JLJVQYjxwKqUCE5fvA/+N2tWZiadJMCMaD7xbY/RoCeXaBZt+3vY9tungD+Z+BKa/urDWD2k/R6W4scAQPbwMV1W5P3gMsdIPykS4bkSH6aQqEAvJ/RN+WA4C3Qt+b21trH6QOQoa6Wb4CDQ2C0SNnrHu/u7ezt3zOt/n4An59yuV4QJP0AAAAGYktHRAD/AP8A/6C9p5MAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfnAhgWIjcvXJFnAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAAD9JREFUKM9jYKA3YEThVVf/x6u6tRWunoloTWiAhZDJuAAT5X4kxqlY/UgMQDKcOD9icQ3ZfmQh5CSqJwD6AwBydhMCgdGliQAAAABJRU5ErkJggg==`,
    7: `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TRZGKQ4sUcchQBcGCqIijVLEIFkpboVUHk0u/oElDkuLiKLgWHPxYrDq4OOvq4CoIgh8gri5Oii5S4v+SQosYD4778e7e4+4dIDQqTDW7JgBVs4xUPCZmc6tizysEhDGIIMYkZuqJ9GIGnuPrHj6+3kV5lve5P0e/kjcZ4BOJ55huWMQbxDObls55nzjESpJCfE48btAFiR+5Lrv8xrnosMAzQ0YmNU8cIhaLHSx3MCsZKvE0cURRNcoXsi4rnLc4q5Uaa92TvzCQ11bSXKc5jDiWkEASImTUUEYFFqK0aqSYSNF+zMM/5PiT5JLJVQYjxwKqUCE5fvA/+N2tWZiadJMCMaD7xbY/RoCeXaBZt+3vY9tungD+Z+BKa/urDWD2k/R6W4scAQPbwMV1W5P3gMsdIPykS4bkSH6aQqEAvJ/RN+WA4C3Qt+b21trH6QOQoa6Wb4CDQ2C0SNnrHu/u7ezt3zOt/n4An59yuV4QJP0AAAAGYktHRAD/AP8A/6C9p5MAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfnAhgWIwJg9GQFAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAAC9JREFUKM9jYKA3YERi/ydFDxM1bMQH/tPVxv/Y1NPMxv+41NLExv/41DExDBkAAG+8BRD8SirxAAAAAElFTkSuQmCC`,
    8: `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw0AcxV9TRZGKQ4sUcchQBcGCqIijVLEIFkpboVUHk0u/oElDkuLiKLgWHPxYrDq4OOvq4CoIgh8gri5Oii5S4v+SQosYD4778e7e4+4dIDQqTDW7JgBVs4xUPCZmc6tizysEhDGIIMYkZuqJ9GIGnuPrHj6+3kV5lve5P0e/kjcZ4BOJ55huWMQbxDObls55nzjESpJCfE48btAFiR+5Lrv8xrnosMAzQ0YmNU8cIhaLHSx3MCsZKvE0cURRNcoXsi4rnLc4q5Uaa92TvzCQ11bSXKc5jDiWkEASImTUUEYFFqK0aqSYSNF+zMM/5PiT5JLJVQYjxwKqUCE5fvA/+N2tWZiadJMCMaD7xbY/RoCeXaBZt+3vY9tungD+Z+BKa/urDWD2k/R6W4scAQPbwMV1W5P3gMsdIPykS4bkSH6aQqEAvJ/RN+WA4C3Qt+b21trH6QOQoa6Wb4CDQ2C0SNnrHu/u7ezt3zOt/n4An59yuV4QJP0AAAAGYktHRAD/AP8A/6C9p5MAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfnAhgWIwn3Jr2NAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAAD9JREFUKM9jYKA3YETmVFdX/8enuLW1lRFDIyFN6JpZCJmMy1AmuvuRchuRbcPnR5gc2TZiDVVioobswKE/AADhyh6EA1X93AAAAABJRU5ErkJggg==`,
    9: `data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw1AUhU9TpSIVBzuoOGSoLloQFXEsVSyChdJWaNXB5KV/0KQhSXFxFFwLDv4sVh1cnHV1cBUEwR8QVxcnRRcp8b6k0CLGB4/3cd47h/vuBYRGhalm1ySgapaRisfEbG5VDLxCwBCAAMYlZuqJ9GIGnuvrHj5+3kV4lve7P1efkjcZ4BOJo0w3LOIN4tlNS+e8TxxiJUkhPieeMKhA4keuyy6/cS46LPDMkJFJzROHiMViB8sdzEqGSjxDHFZUjfKFrMsK5y3OaqXGWnXyHwbz2kqa67RHEMcSEkhChIwayqjAQoROjRQTKbqPefiHHX+SXDK5ymDkWEAVKiTHDz6D3701C9NTblIwBnS/2PbHKA1oF2jWbfv72LabJ4D/GbjS2v5qA5j7JL3e1sJHQP82cHHd1uQ94HIHGHzSJUNyJD9toVAA3s9oTDlg4BboXXP71rrH6QOQoV4t3wAHh8BYkbLXPf7d09m3f9+0+vcDUhJymlU+VpQAAAAGYktHRAAAAAAA/9RBVPIAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfnAhkAFDMBOnysAAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAAylJREFUKBUBHgPh/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAD/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAD/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAEAAAAAAAAAAAAAAAAAAAAAAAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAD/AAAA/wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAABv8CQwwi6JwAAAAAElFTkSuQmCC`,
    empty: ` data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAA4AAAAOCAYAAAAfSC3RAAABhWlDQ1BJQ0MgcHJvZmlsZQAAKJF9kT1Iw1AUhU9TpSIVBzuoOGSoLloQFXEsVSyChdJWaNXB5KV/0KQhSXFxFFwLDv4sVh1cnHV1cBUEwR8QVxcnRRcp8b6k0CLGB4/3cd47h/vuBYRGhalm1ySgapaRisfEbG5VDLxCwBCAAMYlZuqJ9GIGnuvrHj5+3kV4lve7P1efkjcZ4BOJo0w3LOIN4tlNS+e8TxxiJUkhPieeMKhA4keuyy6/cS46LPDMkJFJzROHiMViB8sdzEqGSjxDHFZUjfKFrMsK5y3OaqXGWnXyHwbz2kqa67RHEMcSEkhChIwayqjAQoROjRQTKbqPefiHHX+SXDK5ymDkWEAVKiTHDz6D3701C9NTblIwBnS/2PbHKA1oF2jWbfv72LabJ4D/GbjS2v5qA5j7JL3e1sJHQP82cHHd1uQ94HIHGHzSJUNyJD9toVAA3s9oTDlg4BboXXP71rrH6QOQoV4t3wAHh8BYkbLXPf7d09m3f9+0+vcDUhJymlU+VpQAAAAGYktHRAAAAAAA/9RBVPIAAAAJcEhZcwAALiMAAC4jAXilP3YAAAAHdElNRQfnAhkADjOxF4Z3AAAAGXRFWHRDb21tZW50AENyZWF0ZWQgd2l0aCBHSU1QV4EOFwAAAylJREFUKBUBHgPh/AGampr/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA5eXlAAQAAAAAJCQkAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA5eXlAAQAAAAAAAAAABUVFQAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAADr6+sAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAIAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAQAAAAAAAAAAOvr6wAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAATl5eUA5eXlAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAANmpE9oj7S9hAAAAAElFTkSuQmCC`
}

for(key of Object.keys(img)){
    var b = img[key];
    img[key] = new Image();
    img[key].src = b;
}


function createCanvas(revealed){

    console.log(revealed);

    var canvas = document.querySelector('#canvas');

    let cellSizeX = (document.body.clientWidth - 200) / sx;
    let cellSizeY = (document.body.clientHeight - 200) / sy;

    cellSize = cellSizeX > cellSizeY ? cellSizeY : cellSizeX;

    canvas.width = sx * cellSize + (sx - 1) * borderWidth;
    canvas.height = sy * cellSize + (sy - 1) * borderWidth;

    /*
    var potx = (document.body.clientWidth - 200) / canvas.width;
    var poty = canvas.height * potx;

    if(poty > document.body.clientHeight - 400){
        potx = (document.body.clientHeight - 400) / canvas.height;
    }

    canvas.style.scale = potx;
    */

    ctx = canvas.getContext("2d");

    for(let x = 1; x <= sx; x++){

        ctx.fillRect((cellSize + borderWidth) * x - borderWidth, 0, borderWidth, canvas.height);

    }

    for(let y = 1; y <= sy; y++){

        ctx.fillRect(0, (cellSize + borderWidth) * y - borderWidth, canvas.width, borderWidth);

    }

    map = new Array(sx * sy).fill(undefined);

    map.forEach((c, i)=>{
        drawCell(i, 'empty');
    })

    canvas.addEventListener('click', (e)=>{

        var rect = canvas.getBoundingClientRect();

        socket.emit('game_action_reveal', {
            x: Math.floor((e.pageX - rect.left) / (cellSize + borderWidth)),
            y: Math.floor((e.pageY - rect.top) / (cellSize + borderWidth))
        })

        console.log(e);
    })

}

function drawCell(index, value){

    console.log('draw', value);

    var y = Math.floor(index / sx);
    var x = index - y * sx;

    console.log(index, x, y);

    if(value === 0){
        ctx.fillStyle = "white";
        ctx.fillRect((cellSize + borderWidth) * x, (cellSize + borderWidth) * y, cellSize, cellSize);
        return;
    }

    ctx.drawImage(img[value], (cellSize + borderWidth) * x, (cellSize + borderWidth) * y, cellSize, cellSize);

}

document.querySelector('#btnCreate').addEventListener('click', ()=>{
    socket.emit('game_new', {
        sx: 10,
        sy: 10,
        numMines: 10
    });
})

document.querySelector('#btnJoin').addEventListener('click', ()=>{
    
})

socket.on('game_join_success', (data)=>{

    console.log('game_join_success');

    sx = data.sx;
    sy = data.sy;

    var {revealed} = data;

    createCanvas(revealed);

})

socket.on('reveal', (data)=>{

    var { index, value } = data;

    map[index] = value;
    drawCell(index, value);

})

socket.on('gameover', (data)=>{

    alert(data.won);

})